<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>JobTracker ‚Äì Settings</title>
    <script>
      // Apply theme immediately to prevent flash
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-logo">JobTracker</div>
        <p class="nav-section-title">Menu</p>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="dashboard.html" class="nav-link">
              <span class="icon icon-dashboard"></span>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="index.html" class="nav-link">
              <span class="icon icon-applications"></span>
              Applications
            </a>
          </li>
          <li class="nav-item">
            <a href="recommendations.html" class="nav-link">
              <span class="icon icon-recommendations"></span>
              Recommendations
            </a>
          </li>
          <li class="nav-item">
            <a href="calendar.html" class="nav-link">
              <span class="icon icon-calendar"></span>
              Calendar View
            </a>
          </li>
          <li class="nav-item">
            <a href="settings.html" class="nav-link active">
              <span class="icon icon-settings"></span>
              Settings
            </a>
          </li>
        </ul>
      </aside>

      <div class="main-area">
        <div id="navbar-container"></div>

        <main class="content">
          <div class="page-header">
            <div class="page-title-group">
              <h1>Settings</h1>
              <p>Connect your favorite tools and services</p>
            </div>
          </div>

          <!-- Appearance Settings -->
          <section class="card integration-card">
            <div class="integration-header" style="border-bottom: none; padding-bottom: 0;">
              <div class="integration-info">
                <h3>Appearance</h3>
                <p class="muted">Toggle between light and dark mode</p>
              </div>
              <div class="theme-toggle-container">
                <span class="theme-icon" id="sun-icon">‚òÄÔ∏è</span>
                <label class="switch">
                  <input type="checkbox" id="theme-toggle" />
                  <span class="slider"></span>
                </label>
                <span class="theme-icon" id="moon-icon">üåô</span>
              </div>
            </div>
          </section>

          <!-- Google Integration (Combined Gmail & Calendar) -->
          <section class="card integration-card">
            <div class="integration-header">
              <div class="integration-info">
                <div class="integration-title-row">
                  <h3>Google</h3>
                  <span class="integration-badge">Gmail + Calendar</span>
                </div>
                <p class="muted">Track job applications from email and sync deadlines to your calendar</p>
              </div>
              <label class="switch">
                <input type="checkbox" id="google-toggle" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="integration-content" id="google-content" style="display: none;">
              <div id="google-connected-view" class="google-connected-view" style="display: none;">
                <div class="google-connected-inner">
                  <div class="google-connected-icon">‚úì</div>
                  <div>
                    <h4 class="google-connected-title">Connected to Google</h4>
                    <p id="google-connected-email" class="google-connected-email"></p>
                  </div>
                  <button class="secondary-btn google-disconnect-btn" id="google-disconnect-btn">Disconnect Account</button>
                </div>
              </div>

              <div id="google-setup-view">
                <div class="integration-instructions">
                <h4>Setup Instructions</h4>
                <p>Connect your Google account to enable Gmail scanning for job applications.</p>
              </div>

              <div class="form-section">
                <h4 class="form-section-title">Enable Services</h4>
                <div class="service-toggles">
                  <label class="service-toggle-item">
                    <input type="checkbox" id="enable-gmail" checked />
                    <div class="service-toggle-content">
                      <span class="service-toggle-label">Gmail Integration</span>
                      <span class="service-toggle-desc">Automatically track job applications from your email</span>
                    </div>
                  </label>
                  <label class="service-toggle-item">
                    <input type="checkbox" id="enable-calendar" checked />
                    <div class="service-toggle-content">
                      <span class="service-toggle-label">Calendar Sync</span>
                      <span class="service-toggle-desc">Sync interview dates and deadlines to your calendar</span>
                    </div>
                  </label>
                </div>
              </div>

              <button class="primary-btn" id="google-connect-btn">
                <span>Connect Google Services</span>
              </button>
              </div> <!-- End setup view -->
            </div>
          </section>

        </main>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      // Note: API_BASE_URL and fetchJson are already defined in app.js

      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function showValidationError(inputId, message) {
        const input = document.getElementById(inputId);
        if (input) {
          input.style.borderColor = '#ef4444';
          input.focus();
        }
        
        // Create or update error message
        let errorEl = document.getElementById(`${inputId}-error`);
        if (!errorEl) {
          errorEl = document.createElement('small');
          errorEl.id = `${inputId}-error`;
          errorEl.style.color = '#ef4444';
          errorEl.style.display = 'block';
          errorEl.style.marginTop = '4px';
          errorEl.style.fontSize = '0.875rem';
          input.parentNode.appendChild(errorEl);
        }
        errorEl.textContent = message;
      }

      function clearValidationError(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
          input.style.borderColor = '';
        }
        const errorEl = document.getElementById(`${inputId}-error`);
        if (errorEl) {
          errorEl.remove();
        }
      }

      function clearAllValidationErrors() {
        // Clear any validation errors
      }

      // Load existing integration settings
      async function loadIntegrationSettings() {
        try {
          const integrations = await fetchJson("/api/user/integrations");
          
          // Load Google settings
          if (integrations.google) {
            const google = integrations.google;
            document.getElementById("google-toggle").checked = google.enabled;
            document.getElementById("google-content").style.display = google.enabled ? "block" : "none";
            
            // Check if connected (has credentials)
            const isConnected = google.connected; // Updated to match backend property
            
            const connectedView = document.getElementById("google-connected-view");
            const setupView = document.getElementById("google-setup-view");
            
            if (isConnected) {
                connectedView.style.display = "block";
                setupView.style.display = "none";
                document.getElementById("google-connected-email").textContent = google.email || "Connected Account";
            } else {
                connectedView.style.display = "none";
                setupView.style.display = "block";
            }

            document.getElementById("enable-gmail").checked = google.gmailEnabled;
            document.getElementById("enable-calendar").checked = google.calendarEnabled;
          }
          
        } catch (error) {
          console.error("Failed to load integration settings:", error);
        }
      }

      // Toggle integration content visibility and save state
      function setupToggleHandlers() {
        const toggles = [
          { toggle: "google-toggle", content: "google-content", integration: "google" },
        ];

        toggles.forEach(({ toggle, content, integration }) => {
          const toggleEl = document.getElementById(toggle);
          const contentEl = document.getElementById(content);

          if (toggleEl && contentEl) {
            toggleEl.addEventListener("change", async (e) => {
              const isEnabled = e.target.checked;
              contentEl.style.display = isEnabled ? "block" : "none";
              
              // Auto-save toggle state to backend
              try {
                await fetchJson("/api/user/integrations", {
                  method: "PUT",
                  body: JSON.stringify({
                    [integration]: {
                      enabled: isEnabled
                    }
                  }),
                });
                console.log(`${integration} integration ${isEnabled ? 'enabled' : 'disabled'}`);
              } catch (error) {
                console.error(`Failed to save ${integration} toggle state:`, error);
              }
            });
          }
        });
      }

      // Initialize toggle handlers
      setupToggleHandlers();

      // Disconnect handler
      document.getElementById("google-disconnect-btn")?.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to disconnect Google services? This will stop email tracking.")) {
            return;
        }
        
        try {
            await fetchJson("/api/user/integrations/google", {
                method: "DELETE"
            });
            
            // Reload settings to update UI
            loadIntegrationSettings();
        } catch (error) {
            console.error("Failed to disconnect:", error);
            alert("Failed to disconnect. Please try again.");
        }
      });

      // Google connection handler
      document.getElementById("google-connect-btn")?.addEventListener("click", async () => {
        clearAllValidationErrors();
        
        const gmailEnabled = document.getElementById("enable-gmail").checked;
        const calendarEnabled = document.getElementById("enable-calendar").checked;
        const toggleEnabled = document.getElementById("google-toggle").checked;

        // Check if at least one service is enabled
        if (!gmailEnabled && !calendarEnabled) {
          alert("Please enable at least one service (Gmail or Calendar)");
          return;
        }

        const btn = document.getElementById("google-connect-btn");
        btn.disabled = true;
        btn.querySelector("span").textContent = "Connecting...";

        try {
          // Save preferences first
          await fetchJson("/api/user/integrations", {
            method: "PUT",
            body: JSON.stringify({
              google: {
                enabled: toggleEnabled,
                gmailEnabled: gmailEnabled,
                calendarEnabled: calendarEnabled,
              }
            }),
          });

          // Store JWT in cookie before OAuth redirect (so it persists across the redirect)
          document.cookie = `jwtToken=${localStorage.getItem('jwtToken')}; path=/`;
          console.log("[Google OAuth] JWT stored in cookie");

          // Now redirect - the cookie will be automatically sent
          window.location.href = "/api/oauth/google/authorize";
          
        } catch (error) {
          console.error("Failed to initiate Google connection:", error);
          alert("Failed to connect. Please try again.");
          btn.querySelector("span").textContent = "Connect Google Services";
          btn.disabled = false;
        }
      });

      // Theme toggle functionality
      function initThemeSettings() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        
        // Set initial state
        updateThemeUI(savedTheme);
        
        // Toggle switch handler
        themeToggle.addEventListener('change', (e) => {
          const theme = e.target.checked ? 'dark' : 'light';
          applyTheme(theme);
        });
      }
      
      function updateThemeUI(theme) {
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        
        if (theme === 'dark') {
          themeToggle.checked = true;
          sunIcon.classList.remove('active');
          moonIcon.classList.add('active');
        } else {
          themeToggle.checked = false;
          sunIcon.classList.add('active');
          moonIcon.classList.remove('active');
        }
      }
      
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        updateThemeUI(theme);
      }

      // Load settings on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadIntegrationSettings();
        initThemeSettings();
      });
    </script>
  </body>
</html>
