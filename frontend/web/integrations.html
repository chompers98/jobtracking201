<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>JobTracker – Integrations</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-logo">JobTracker</div>
        <p class="nav-section-title">Menu</p>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="dashboard.html" class="nav-link">
              <span class="icon icon-dashboard"></span>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="index.html" class="nav-link">
              <span class="icon icon-applications"></span>
              Applications
            </a>
          </li>
          <li class="nav-item">
            <a href="recommendations.html" class="nav-link">
              <span class="icon icon-recommendations"></span>
              Recommendations
            </a>
          </li>
          <li class="nav-item">
            <a href="calendar.html" class="nav-link">
              <span class="icon icon-calendar"></span>
              Calendar View
            </a>
          </li>
          <li class="nav-item">
            <a href="integrations.html" class="nav-link active">
              <span class="icon icon-integrations"></span>
              Integrations
            </a>
          </li>
          <li class="nav-item">
            <a href="settings.html" class="nav-link">
              <span class="icon icon-settings"></span>
              Settings
            </a>
          </li>
        </ul>
      </aside>

      <div class="main-area">
        <header class="top-bar">
          <div class="top-bar-right">
            <span>Logout</span>
            <div class="avatar">JD</div>
          </div>
        </header>

        <main class="content">
          <div class="page-header">
            <div class="page-title-group">
              <h1>Integrations</h1>
              <p>Connect your favorite tools and services</p>
            </div>
          </div>

          <!-- Google Integration (Combined Gmail & Calendar) -->
          <section class="card integration-card">
            <div class="integration-header">
              <div class="integration-info">
                <div class="integration-title-row">
                  <h3>Google</h3>
                  <span class="integration-badge">Gmail + Calendar</span>
                </div>
                <p class="muted">Track job applications from email and sync deadlines to your calendar</p>
              </div>
              <label class="switch">
                <input type="checkbox" id="google-toggle" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="integration-content" id="google-content" style="display: none;">
              <div class="integration-instructions">
                <h4>Setup Instructions</h4>
                <ol>
                  <li>Go to <a href="https://console.cloud.google.com/" target="_blank" rel="noreferrer">Google Cloud Console</a></li>
                  <li>Create a new project or select an existing one</li>
                  <li>Enable the <strong>Gmail API</strong> and <strong>Google Calendar API</strong></li>
                  <li>Create OAuth 2.0 credentials (Web application or Desktop app)</li>
                  <li>Add authorized redirect URI: <code>http://localhost:5000/oauth/google/callback</code></li>
                  <li>Download the credentials JSON file</li>
                </ol>
                <p class="muted">
                  Required OAuth Scopes: 
                  <code>gmail.readonly</code>, <code>gmail.modify</code>, 
                  <code>calendar.events</code>, <code>calendar.readonly</code>
                </p>
              </div>

              <div class="form-section">
                <h4 class="form-section-title">Google Account Details</h4>
                <div class="form-group">
                  <label for="google-account">Google Account Email</label>
                  <input
                    type="email"
                    id="google-account"
                    placeholder="your-email@gmail.com"
                    class="form-input modern-input"
                  />
                </div>
                <div class="form-group">
                  <label for="google-client-id">OAuth 2.0 Client ID</label>
                  <input
                    type="text"
                    id="google-client-id"
                    placeholder="Enter your OAuth 2.0 Client ID"
                    class="form-input modern-input"
                  />
                </div>
                <div class="form-group">
                  <label for="google-client-secret">OAuth 2.0 Client Secret</label>
                  <input
                    type="password"
                    id="google-client-secret"
                    placeholder="Enter your OAuth 2.0 Client Secret"
                    class="form-input modern-input"
                  />
                </div>
              </div>

              <div class="form-section">
                <h4 class="form-section-title">Enable Services</h4>
                <div class="service-toggles">
                  <label class="service-toggle-item">
                    <input type="checkbox" id="enable-gmail" checked />
                    <div class="service-toggle-content">
                      <span class="service-toggle-label">Gmail Integration</span>
                      <span class="service-toggle-desc">Automatically track job applications from your email</span>
                    </div>
                  </label>
                  <label class="service-toggle-item">
                    <input type="checkbox" id="enable-calendar" checked />
                    <div class="service-toggle-content">
                      <span class="service-toggle-label">Calendar Sync</span>
                      <span class="service-toggle-desc">Sync interview dates and deadlines to your calendar</span>
                    </div>
                  </label>
                </div>
              </div>

              <button class="primary-btn" id="google-connect-btn">
                <span>Connect Google Services</span>
              </button>
            </div>
          </section>

          <!-- OpenAI Integration -->
          <section class="card integration-card">
            <div class="integration-header">
              <div class="integration-info">
                <h3>OpenAI</h3>
                <p class="muted">AI-powered status tracking from email natural language</p>
              </div>
              <label class="switch">
                <input type="checkbox" id="openai-toggle" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="integration-content" id="openai-content" style="display: none;">
              <div class="integration-instructions">
                <h4>Setup Instructions</h4>
                <ol>
                  <li>Go to <a href="https://platform.openai.com/" target="_blank" rel="noreferrer">OpenAI Platform</a></li>
                  <li>Sign up or log in to your account</li>
                  <li>Navigate to <strong>API Keys</strong> section</li>
                  <li>Click <strong>Create new secret key</strong></li>
                  <li>Copy the API key (it won't be shown again!)</li>
                  <li>Paste it below and click "Verify & Load Models"</li>
                </ol>
                <p class="muted">
                  Note: Keep your API key secure. Never share it or commit it to version control.
                </p>
              </div>

              <div class="form-section">
                <h4 class="form-section-title">API Configuration</h4>
                <div class="form-group">
                  <label for="openai-api-key">OpenAI API Key</label>
                  <div class="input-with-button">
                    <input
                      type="password"
                      id="openai-api-key"
                      placeholder="sk-proj-..."
                      class="form-input modern-input"
                    />
                    <button class="secondary-btn" id="verify-key-btn">
                      <span id="verify-btn-text">Verify & Load Models</span>
                    </button>
                  </div>
                  <small class="input-hint">Your API key is stored locally and never shared</small>
                </div>

                <div class="form-group" id="model-selection-group" style="display: none;">
                  <label for="openai-model">Select Model</label>
                  <select id="openai-model" class="form-input modern-input">
                    <option value="">Loading models...</option>
                  </select>
                  <small class="input-hint" id="model-hint">Choose the model that best fits your needs</small>
                </div>
              </div>

              <button class="primary-btn" id="openai-save-btn" style="display: none;">
                <span>Save Configuration</span>
              </button>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      // Note: API_BASE_URL and fetchJson are already defined in app.js

      // Validation helpers
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function validateGoogleClientId(clientId) {
        // Google Client IDs typically end with .apps.googleusercontent.com
        return clientId && clientId.length > 20 && clientId.includes('.apps.googleusercontent.com');
      }

      function validateGoogleClientSecret(secret) {
        // Google client secrets are typically 24-35 characters
        return secret && secret.length >= 24;
      }

      function validateOpenAIKey(apiKey) {
        // OpenAI keys start with 'sk-' or 'sk-proj-' and are at least 40 characters
        return apiKey && (apiKey.startsWith('sk-') || apiKey.startsWith('sk-proj-')) && apiKey.length >= 40;
      }

      // Test credential validity with actual API requests
      async function testGoogleCredentials(email, clientId, clientSecret) {
        // Test request to verify Google OAuth credentials structure
        // In a real implementation, this would initiate OAuth flow or validate with Google
        try {
          // Make a test request to our backend to validate credentials
          const response = await fetchJson("/api/user/integrations/google/validate", {
            method: "POST",
            body: JSON.stringify({
              email: email,
              clientId: clientId,
              clientSecret: clientSecret
            })
          });
          return response.valid === true;
        } catch (error) {
          console.error("Google credentials validation failed:", error);
          return false;
        }
      }

      async function testOpenAIKey(apiKey) {
        // Test the OpenAI API key by making a lightweight request
        try {
          const response = await fetch("https://api.openai.com/v1/models", {
            method: "GET",
            headers: {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json",
            },
          });
          return response.ok;
        } catch (error) {
          console.error("OpenAI API key validation failed:", error);
          return false;
        }
      }

      function showValidationError(inputId, message) {
        const input = document.getElementById(inputId);
        if (input) {
          input.style.borderColor = '#ef4444';
          input.focus();
        }
        
        // Create or update error message
        let errorEl = document.getElementById(`${inputId}-error`);
        if (!errorEl) {
          errorEl = document.createElement('small');
          errorEl.id = `${inputId}-error`;
          errorEl.style.color = '#ef4444';
          errorEl.style.display = 'block';
          errorEl.style.marginTop = '4px';
          errorEl.style.fontSize = '0.875rem';
          input.parentNode.appendChild(errorEl);
        }
        errorEl.textContent = message;
      }

      function clearValidationError(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
          input.style.borderColor = '';
        }
        const errorEl = document.getElementById(`${inputId}-error`);
        if (errorEl) {
          errorEl.remove();
        }
      }

      function clearAllValidationErrors() {
        ['google-account', 'google-client-id', 'google-client-secret', 'openai-api-key', 'openai-model'].forEach(clearValidationError);
      }

      // Load existing integration settings
      async function loadIntegrationSettings() {
        try {
          const integrations = await fetchJson("/api/user/integrations");
          
          // Load Google settings
          if (integrations.google) {
            const google = integrations.google;
            document.getElementById("google-toggle").checked = google.enabled;
            document.getElementById("google-content").style.display = google.enabled ? "block" : "none";
            document.getElementById("google-account").value = google.email || "";
            document.getElementById("google-client-id").value = google.clientId || "";
            document.getElementById("google-client-secret").value = google.clientSecret || "";
            document.getElementById("enable-gmail").checked = google.gmailEnabled;
            document.getElementById("enable-calendar").checked = google.calendarEnabled;
          }
          
          // Load OpenAI settings
          if (integrations.openai) {
            const openai = integrations.openai;
            document.getElementById("openai-toggle").checked = openai.enabled;
            document.getElementById("openai-content").style.display = openai.enabled ? "block" : "none";
            document.getElementById("openai-api-key").value = openai.apiKey || "";
            
            // If model is saved, show the model selection
            if (openai.model) {
              const modelGroup = document.getElementById("model-selection-group");
              const modelSelect = document.getElementById("openai-model");
              const saveBtn = document.getElementById("openai-save-btn");
              
              modelGroup.style.display = "block";
              saveBtn.style.display = "inline-flex";
              
              // Create an option for the saved model
              modelSelect.innerHTML = `<option value="${openai.model}" selected>${openai.model}</option>`;
            }
          }
        } catch (error) {
          console.error("Failed to load integration settings:", error);
        }
      }

      // Toggle integration content visibility and save state
      function setupToggleHandlers() {
        const toggles = [
          { toggle: "google-toggle", content: "google-content", integration: "google" },
          { toggle: "openai-toggle", content: "openai-content", integration: "openai" },
        ];

        toggles.forEach(({ toggle, content, integration }) => {
          const toggleEl = document.getElementById(toggle);
          const contentEl = document.getElementById(content);

          if (toggleEl && contentEl) {
            toggleEl.addEventListener("change", async (e) => {
              const isEnabled = e.target.checked;
              contentEl.style.display = isEnabled ? "block" : "none";
              
              // Auto-save toggle state to backend
              try {
                await fetchJson("/api/user/integrations", {
                  method: "PUT",
                  body: JSON.stringify({
                    [integration]: {
                      enabled: isEnabled
                    }
                  }),
                });
                console.log(`${integration} integration ${isEnabled ? 'enabled' : 'disabled'}`);
              } catch (error) {
                console.error(`Failed to save ${integration} toggle state:`, error);
              }
            });
          }
        });
      }

      // Initialize toggle handlers
      setupToggleHandlers();

      // Google connection handler
      document.getElementById("google-connect-btn")?.addEventListener("click", async () => {
        clearAllValidationErrors();
        
        const email = document.getElementById("google-account").value.trim();
        const clientId = document.getElementById("google-client-id").value.trim();
        const clientSecret = document.getElementById("google-client-secret").value.trim();
        const gmailEnabled = document.getElementById("enable-gmail").checked;
        const calendarEnabled = document.getElementById("enable-calendar").checked;
        const toggleEnabled = document.getElementById("google-toggle").checked;

        // Validate email
        if (!email) {
          showValidationError("google-account", "Email is required");
          return;
        }
        if (!validateEmail(email)) {
          showValidationError("google-account", "Please enter a valid email address");
          return;
        }

        // Validate Client ID
        if (!clientId) {
          showValidationError("google-client-id", "OAuth 2.0 Client ID is required");
          return;
        }
        if (!validateGoogleClientId(clientId)) {
          showValidationError("google-client-id", "Invalid Client ID format. Should end with .apps.googleusercontent.com");
          return;
        }

        // Validate Client Secret
        if (!clientSecret) {
          showValidationError("google-client-secret", "OAuth 2.0 Client Secret is required");
          return;
        }
        if (!validateGoogleClientSecret(clientSecret)) {
          showValidationError("google-client-secret", "Invalid Client Secret format. Should be at least 24 characters");
          return;
        }

        // Check if at least one service is enabled
        if (!gmailEnabled && !calendarEnabled) {
          alert("Please enable at least one service (Gmail or Calendar)");
          return;
        }

        const btn = document.getElementById("google-connect-btn");
        btn.disabled = true;
        btn.querySelector("span").textContent = "Validating...";

        // Test credentials first
        const isValid = await testGoogleCredentials(email, clientId, clientSecret);
        
        if (!isValid) {
          alert("Failed to validate Google credentials. Please check your Client ID and Client Secret and try again.");
          btn.querySelector("span").textContent = "Connect Google Services";
          btn.disabled = false;
          return;
        }

        btn.querySelector("span").textContent = "Connecting...";

        try {
          await fetchJson("/api/user/integrations", {
            method: "PUT",
            body: JSON.stringify({
              google: {
                enabled: toggleEnabled,
                email: email,
                clientId: clientId,
                clientSecret: clientSecret,
                gmailEnabled: gmailEnabled,
                calendarEnabled: calendarEnabled,
              }
            }),
          });

          const services = [];
          if (gmailEnabled) services.push("Gmail");
          if (calendarEnabled) services.push("Calendar");

          btn.querySelector("span").textContent = "✓ Connected";
          btn.classList.add("success");
          
          setTimeout(() => {
            btn.querySelector("span").textContent = "Connect Google Services";
            btn.disabled = false;
            btn.classList.remove("success");
          }, 2000);

          alert(`Google services (${services.join(", ")}) connected successfully for ${email}`);
        } catch (error) {
          console.error("Failed to save Google integration:", error);
          alert("Failed to save Google integration. Please try again.");
          btn.querySelector("span").textContent = "Connect Google Services";
          btn.disabled = false;
        }
      });

      // OpenAI API Key verification and model loading
      document.getElementById("verify-key-btn")?.addEventListener("click", async () => {
        clearValidationError("openai-api-key");
        
        const apiKey = document.getElementById("openai-api-key").value.trim();
        const verifyBtn = document.getElementById("verify-key-btn");
        const verifyBtnText = document.getElementById("verify-btn-text");
        const modelSelect = document.getElementById("openai-model");
        const modelGroup = document.getElementById("model-selection-group");
        const saveBtn = document.getElementById("openai-save-btn");

        // Validate API key
        if (!apiKey) {
          showValidationError("openai-api-key", "OpenAI API key is required");
          return;
        }
        if (!validateOpenAIKey(apiKey)) {
          showValidationError("openai-api-key", "Invalid API key format. Should start with 'sk-' or 'sk-proj-' and be at least 40 characters");
          return;
        }

        // Show loading state
        verifyBtn.disabled = true;
        verifyBtnText.textContent = "Verifying...";

        try {
          // Fetch available models from OpenAI API
          const response = await fetch("https://api.openai.com/v1/models", {
            method: "GET",
            headers: {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error("Invalid API key or network error");
          }

          const data = await response.json();
          
          // Filter for chat/completion models and sort by relevance
          const relevantModels = data.data
            .filter(model => {
              const id = model.id.toLowerCase();
              return id.includes('gpt') && !id.includes('instruct') && !id.includes('0301');
            })
            .sort((a, b) => {
              // Priority order for display
              const priority = {
                'gpt-4': 1,
                'gpt-4-turbo': 2,
                'gpt-4o': 3,
                'gpt-3.5-turbo': 4,
              };
              const aId = a.id;
              const bId = b.id;
              const aPriority = Object.entries(priority).find(([key]) => aId.startsWith(key))?.[1] || 999;
              const bPriority = Object.entries(priority).find(([key]) => bId.startsWith(key))?.[1] || 999;
              return aPriority - bPriority;
            });

          // Populate the select dropdown
          modelSelect.innerHTML = "";
          
          if (relevantModels.length === 0) {
            modelSelect.innerHTML = '<option value="">No models available</option>';
          } else {
            relevantModels.forEach((model, index) => {
              const option = document.createElement("option");
              option.value = model.id;
              
              // Add helpful descriptions
              let description = model.id;
              if (model.id.includes('gpt-4o')) {
                description += ' (Latest & Most Capable)';
              } else if (model.id.includes('gpt-4-turbo')) {
                description += ' (Fast & Capable)';
              } else if (model.id.includes('gpt-4') && !model.id.includes('turbo')) {
                description += ' (High Quality)';
              } else if (model.id.includes('gpt-3.5-turbo')) {
                description += ' (Fast & Economical)';
              }
              
              option.textContent = description;
              if (index === 0) option.selected = true;
              modelSelect.appendChild(option);
            });
          }

          // Show model selection and save button
          modelGroup.style.display = "block";
          saveBtn.style.display = "inline-flex";
          
          verifyBtnText.textContent = "✓ Verified";
          verifyBtn.classList.add("success");
          
          setTimeout(() => {
            verifyBtnText.textContent = "Reload Models";
            verifyBtn.disabled = false;
            verifyBtn.classList.remove("success");
          }, 2000);

        } catch (error) {
          alert("Failed to verify API key. Please check your key and try again.");
          verifyBtnText.textContent = "Verify & Load Models";
          verifyBtn.disabled = false;
          console.error("OpenAI API Error:", error);
        }
      });

      // OpenAI save configuration
      document.getElementById("openai-save-btn")?.addEventListener("click", async () => {
        clearAllValidationErrors();
        
        const apiKey = document.getElementById("openai-api-key").value.trim();
        const model = document.getElementById("openai-model").value;
        const toggleEnabled = document.getElementById("openai-toggle").checked;
        
        // Validate API key
        if (!apiKey) {
          showValidationError("openai-api-key", "OpenAI API key is required");
          return;
        }
        if (!validateOpenAIKey(apiKey)) {
          showValidationError("openai-api-key", "Invalid API key format");
          return;
        }

        // Validate model selection
        if (!model) {
          showValidationError("openai-model", "Please select a model");
          return;
        }

        const btn = document.getElementById("openai-save-btn");
        btn.disabled = true;
        btn.querySelector("span").textContent = "Validating...";

        // Test API key before saving
        const isValid = await testOpenAIKey(apiKey);
        
        if (!isValid) {
          alert("Failed to validate OpenAI API key. Please check your key and try again.");
          btn.querySelector("span").textContent = "Save Configuration";
          btn.disabled = false;
          return;
        }

        btn.querySelector("span").textContent = "Saving...";

        try {
          await fetchJson("/api/user/integrations", {
            method: "PUT",
            body: JSON.stringify({
              openai: {
                enabled: toggleEnabled,
                apiKey: apiKey,
                model: model,
              }
            }),
          });

          btn.querySelector("span").textContent = "✓ Saved";
          btn.classList.add("success");
          
          setTimeout(() => {
            btn.querySelector("span").textContent = "Save Configuration";
            btn.disabled = false;
            btn.classList.remove("success");
          }, 2000);

          alert(`OpenAI configuration saved!\nModel: ${model}`);
        } catch (error) {
          console.error("Failed to save OpenAI integration:", error);
          alert("Failed to save OpenAI configuration. Please try again.");
          btn.querySelector("span").textContent = "Save Configuration";
          btn.disabled = false;
        }
      });

      // Load settings on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadIntegrationSettings();
      });
    </script>
  </body>
</html>
